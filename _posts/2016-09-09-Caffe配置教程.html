<h2>Caffe配置简明教程 ( Ubuntu 14.04 / CUDA 7.5 / cuDNN 5.1 / OpenCV 3.1 )</h2>
<p><strong><span style="font-size: 18px;">1. 前言</span></strong></p>
<p>本教程使用的系统是Ubuntu 14.04 LTS 64-bit，使用的CUDA版本为7.5，使用的NVIDIA驱动版本为352。</p>
<p>如果您使用的Pascal架构显卡，如GTX1080或者新ttx，则必须使用更高版本的驱动和CUDA 8。本教程不适于这种情况，请不要尝试。<strong><a href="https://developer.nvidia.com/pascal"><br /></a></strong></p>
<p>Ubuntu每两年发布一次LTS版本（即长期支持版），所以现在已经发布了16.04 LTS版本。鉴于很多程序在新系统下的兼容性还没有测试，本教程依然介绍的是上一个LTS版本上安装Caffe的方法，随后会推出针对于Ubuntu 16.04和CUDA 8的教程。</p>
<p>本教程很多细节已经尽量详细，但是还是要求使用者有一定的Linux基础，后续可能会推出针对于Linux新用户的更为详细的教程。</p>
<p><span style="font-size: 18px;"><strong>2. 安装基础依赖项</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> build-essential</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> cmake git</pre>
</div>
<p><strong><span style="font-size: 18px;">3. 安装NVIDIA驱动(optional)</span></strong></p>
<p><span style="color: #ff0000;">如果你没有NVIDIA显卡，或者只需要使用CPU-only模式，请不要安装NVIDIA驱动和CUDA，否则会造成Ubuntu图形界面无法启动。</span></p>
<p>首先需要关闭图形界面，使用Ctrl+Alt+F1进入虚拟控制台，然后输入用户名和密码登陆。</p>
<p>然后关闭lightdm</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> /etc/init.d/lightdm stop</pre>
</div>
<p>然后更新源，并从Ubuntu官方源中安装NVIDIA 352驱动</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> nvidia-<span style="color: #800080;">352</span></pre>
</div>
<p>这是目前官方源中最新的驱动版本，由于16.04的推出，Ubuntu官方源应该不会再更新14.04的驱动版本。如果需要更高版本的驱动，可以前往<a href="http://www.nvidia.com/Download/index.aspx?lang=en-us" target="_blank">NVIDIA官网</a>进行下载。</p>
<p>然后重启电脑即可。</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> reboot</pre>
</div>
<p><span style="color: #888888;">PS：用这种方式安装NVIDIA显卡驱动，会自动覆盖Ubuntu的X Server配置，这样如果你的显示器连接的不是NVIDIA显卡，就无法正常启动图形界面。使用Tesla等计算卡的同学们请注意这一点。</span></p>
<p><span style="font-size: 18px;"><strong>4. 安装CUDA 7.5(optional)</strong></span></p>
<p>CUDA的本地安装包中含有NVIDIA驱动，如果没有进行步骤3，安装CUDA时会自动安装NVIDIA驱动，所以没有NVIDIA显卡请不要安装CUDA。另外NVIDIA驱动最好按照步骤3单独安装。</p>
<p>从NVIDIA官网下载CUDA 7.5的deb本地安装包：<a href="http://developer.download.nvidia.com/compute/cuda/7.5/Prod/local_installers/cuda-repo-ubuntu1404-7-5-local_7.5-18_amd64.deb" target="_blank">下载地址</a></p>
<p>点击如上的链接可以下载支持x86架构CPU和Ubuntu 14.04系统的deb本地安装包，大小约1.9GB，如果需要其他安装方式可以按官网教程进行。</p>
<p>下载完成后，打开Terminal，前往指定的目录，然后执行：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> dpkg -i <span style="color: #000000;">cuda-repo-ubuntu1404-7-5-local_7.5-18_amd64.deb</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get update</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> cuda</pre>
</div>
<p>安装完成后，需要添加环境变量。使用gedit打开如下文档：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> gedit /etc/profile</pre>
</div>
<p>在文件末尾添加：</p>
<div class="cnblogs_code">
<pre>PATH=/usr/local/cuda/<span style="color: #000000;">bin:$PATH
export PATH</span></pre>
</div>
<p>保存完成后，执行如下命令使环境变量立即生效：</p>
<div class="cnblogs_code">
<pre>source /etc/profile</pre>
</div>
<p>然后还需要添加lib的路径：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> gedit<span style="color: #000000;"> /etc/ld.so.conf.</span>d/cuda.conf</pre>
</div>
<p>在文件中写入如下内容然后保存：</p>
<div class="cnblogs_code">
<pre>/usr/local/cuda/lib64</pre>
</div>
<p>之后执行如下命令使之生效：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> ldconfig</pre>
</div>
<p><span style="color: #888888;">PS：上面的命令使L-D-C-O-N-F-I-G!!! 无数的人把L写成了I，然后告诉我报错。</span></p>
<p>执行完了这些操作之后，还可以安装CUDA SAMPLES来检测CUDA是否运行正常，鉴于这不是CUDA编程教程，本教程暂不介绍。</p>
<p><strong><span style="font-size: 18px;">4. 安装其他的一些依赖项</span></strong></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> freeglut3-dev libx11-dev libxmu-dev libxi-dev libglu1-mesa-dev</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> <span style="color: #000000;">libgtk2.0-dev </span><span style="color: #000000;">pkg-config</span> libavcodec-dev libavformat-dev libswscale-dev</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-<span style="color: #000000;">dev libjasper-dev libdc1394-22-dev</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libboost-all-dev libhdf5-serial-dev libgflags-dev libgoogle-glog-dev liblmdb-dev protobuf-compiler</pre>
</div>
<p><span style="font-size: 14px;"><span style="color: #888888;">PS：复制粘贴太长的命令可以能因为浏览器的原因导致输入了多余的换行符，如果复制粘贴带有换行符的命令进Terminal，会被当做两条命令来执行，一定要注意这一点。</span></span></p>
<p><strong><span style="font-size: 18px;">5. 安装ATLAS</span></strong></p>
<p>本步骤可以用OpenBLAS或者Intel MKL替代。我在E5-2690v2+GTX780的平台上测试过这三种库，性能相差无几，这里就介绍其中一种：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> libatlas-base-dev</pre>
</div>
<p>然后自动安装完成即可。</p>
<p>目前intel MKL是收费软件，OpenBLAS可以免费下载和安装。如果使用这两种库，编译Caffe时要在Makefile.config做出对应的修改。</p>
<p><span style="font-size: 14pt;"><strong>6. 安装OpenCV</strong></span></p>
<p>从OpenCV官网上下载OpenCV官网上下载OpenCV的未编译源代码：</p>
<p><a href="http://opencv.org/downloads.html" target="_blank">点击这里</a></p>
<p>国内很多网络打开OpenCV官网速度缓慢，可以点击如下地址直接从GitHub上下载OpenCV 3.1的源代码</p>
<p><a href="https://codeload.github.com/opencv/opencv/zip/3.1.0" target="_blank">下载地址</a></p>
<p>下载完成后解压缩，然后在Terminal中转到该目录下，执行</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">mkdir</span> build</pre>
</div>
<div class="cnblogs_code">
<pre>cd build</pre>
</div>
<div class="cnblogs_code">
<pre>cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr/local ..</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">make</span> -j10</pre>
</div>
<p><span style="color: #888888;">PS:上一句代码中的-j10指10线程同时编译，根据自己CPU的特点调整该参数，如果不了解自己CPU，直接执行make即可。</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> <span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span></pre>
</div>
<p><span style="font-size: 18px;"><strong>7.下载Caffe</strong></span></p>
<p>从GitHub上直接下载Caffe的最新版</p>
<div class="cnblogs_code">
<pre>git clone <span style="color: #000000;">https://github.com/BVLC/caffe.git</span></pre>
</div>
<p><span style="font-size: 14px;">也可以从Caffe的GitHub工程中下载Caffe的历史版本：</span></p>
<p><a href="https://github.com/BVLC/caffe" target="_blank">https://github.com/BVLC/caffe</a></p>
<p><strong><span style="font-size: 18px;">8. 安装Python(optional)</span></strong></p>
<p>先安装相关依赖项</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> apt-get <span style="color: #0000ff;">install</span> python-dev python-pip</pre>
</div>
<p>转到下载的caffe的目录下，然后转到python目录下</p>
<div class="cnblogs_code">
<pre>cd python</pre>
</div>
<p>执行如下命令：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">for</span> req <span style="color: #0000ff;">in</span> $(<span style="color: #0000ff;">cat</span> requirements.txt); <span style="color: #0000ff;">do</span> <span style="color: #0000ff;">sudo</span> pip <span style="color: #0000ff;">install</span> $req; <span style="color: #0000ff;">done</span></pre>
</div>
<p>等待其自动安装即可。</p>
<p><span style="font-size: 14pt;"><strong>9. 安装MATLAB(optional)</strong></span></p>
<p>本步骤为可选项目，MATLAB为收费软件，请支持正版。</p>
<p><span style="font-size: 14pt;"><strong>10. 配置cuDNN(optional)</strong></span></p>
<p>cuDNN需要注册Accelerated Computing Developer Program，然后可以免费下载。</p>
<p>cuDNN是The NVIDIA CUDA Deep Neural Network library，对于使用NVIDIA显卡进行深度学习加速具有很大的性能提升，非常建议添加。</p>
<p>在如下地址进行注册和下载，支持下载历史版本：</p>
<p><a href="https://developer.nvidia.com/cudnn" target="_blank">点击这里</a></p>
<p><span style="color: #888888;">PS：另外，cuDNN在很多工程中兼容性较差，可能需要安装特定的历史版本。</span></p>
<p>下载后解压缩，转到该目录下，执行：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> <span style="color: #0000ff;">cp</span> lib* /usr/local/cuda/lib64/</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> <span style="color: #0000ff;">cp</span> cudnn.h /usr/local/cuda/include/</pre>
</div>
<p>更新软链接</p>
<div class="cnblogs_code">
<pre>cd /usr/local/cuda/lib64/<span style="color: #0000ff;"><br /></span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> <span style="color: #0000ff;">rm</span> -rf libcudnn.so libcudnn.so.<span style="color: #800080;">5</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> <span style="color: #0000ff;">ln</span> -s libcudnn.so.<span style="color: #800080;">5.1</span>.<span style="color: #800080;">3</span> libcudnn.so.<span style="color: #800080;">5</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sudo</span> <span style="color: #0000ff;">ln</span> -s libcudnn.so.<span style="color: #800080;">5</span> libcudnn.so</pre>
</div>
<p>PS：根据你下载的cuDNN版本不同，需要对如上命令中的版本进行修改，以上展示的命令是对于cuDNN 5.1.3的。</p>
<p><strong><span style="font-size: 14pt;">11. 编译Caffe</span></strong></p>
<p><span style="font-size: 14px;">在caffe目录下，执行：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">cp</span> Makefile.config.example Makefile.config</pre>
</div>
<p>然后打开Makefile.config，根据自己的需要修改相关参数。</p>
<p>如果使用了cuDNN,则如下行取消注释：</p>
<div class="cnblogs_code">
<pre># USE_CUDNN := <span style="color: #800080;">1</span></pre>
</div>
<p>如上教程中，使用了OpenCV 3.1，则如下行取消注释：</p>
<div class="cnblogs_code">
<pre># OPENCV_VERSION := <span style="color: #800080;">3</span></pre>
</div>
<p>其他可以根据需求修改，比如安装了MATLAB后写入正确的MATLAB安装路径等。</p>
<p>然后进行编译：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">make</span> all -<span style="color: #000000;">j10</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">make</span> test</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">make</span> runtest</pre>
</div>
<p><span style="color: #888888;">PS：-j10这一参数已经在前面的教程中说过了，再说一次：</span></p>
<p><span style="color: #888888;">&nbsp; &nbsp; &nbsp; -j10指10线程同时编译，根据自己CPU的特点调整该参数，如果不了解自己CPU，直接执行make即可。</span></p>
<p>然后可以根据需求编译matcaffe和pycaffe：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">make</span><span style="color: #000000;"> matcaffe</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">make</span> pycaffe</pre>
</div>
<p>然后caffe就安装结束了。</p>
<p><strong><span style="font-size: 18px;">12. 运行minist demo</span></strong></p>
<p><span class="fontstyle0">转到 Caffe 目录下 <br /></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sh</span> data/mnist/get_mnist.<span style="color: #0000ff;">sh</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sh</span> examples/mnist/create_mnist.<span style="color: #0000ff;">sh</span></pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">sh</span> examples/mnist/train_lenet.<span style="color: #0000ff;">sh</span></pre>
</div>
<p>如果运行正常，caffe就可以正常工作了。</p>
<p>&nbsp;</p>
<p>本教程编写参考了如下教程，特此鸣谢：<a href="http://www.cnblogs.com/platero/p/3993877.html" target="_blank">http://www.cnblogs.com/platero/p/3993877.html</a></p>
<p>Caffe的官方网站是&nbsp;<a href="http://caffe.berkeleyvision.org/" target="_blank">http://caffe.berkeleyvision.org/</a></p>
<p>&nbsp;</p>
<p>如果有任何问题可以联系我：</p>
<p><span style="color: #0000ff;">me@yaoyao.ac.cn</span></p>
<p>&nbsp;</p>
<p><span style="color: #000000;">最近更新于2016-09-09&nbsp;13:33:06</span></p>
